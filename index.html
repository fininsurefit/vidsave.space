<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidsSave.space - HD Video Downloader</title>
    <meta name="referrer" content="no-referrer">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- SAME STYLING AS BEFORE --- */
        :root { --primary: #00CBA9; --dark: #333; --bg: #f4f6f8; --white: #fff; --mp3-bg: #f1c40f; --mp4-bg: #e67e22; --border: #e1e1e1; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--dark); padding-bottom: 50px; }
        nav { background: var(--white); padding: 15px 5%; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 24px; font-weight: 800; color: var(--dark); text-decoration: none; }
        .logo span { color: var(--primary); }
        .hero { background: var(--white); padding: 30px 20px; text-align: center; border-bottom: 1px solid #ddd; }
        .search-box { max-width: 600px; margin: 15px auto; display: flex; border: 2px solid var(--primary); border-radius: 50px; overflow: hidden; background: #fff; }
        input { flex: 1; padding: 15px; border: none; outline: none; font-size: 16px; }
        .btn-go { background: var(--primary); color: white; border: none; padding: 0 25px; font-size: 18px; cursor: pointer; }
        #loader { display: none; margin-top: 15px; color: var(--primary); font-weight: bold; }
        #result-area { max-width: 700px; margin: 20px auto; padding: 0 15px; }
        .result-card { background: var(--white); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid var(--border); }
        .card-header { padding: 20px; text-align: center; border-bottom: 1px solid var(--border); background: #fff; }
        .thumb-img { width: 100%; max-width: 400px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .video-title { margin-top: 15px; font-size: 16px; font-weight: 700; line-height: 1.4; color: #2c3e50; }
        .video-meta { margin-top: 5px; font-size: 13px; color: #7f8c8d; }
        .category-header { background: #f8f9fa; padding: 10px 20px; font-weight: 700; font-size: 15px; color: #555; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); border-top: 1px solid var(--border); }
        .category-header i { color: var(--primary); }
        .category-header:first-child { border-top: none; }
        .dl-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f1f1f1; }
        .dl-item:last-child { border-bottom: none; }
        .dl-info { display: flex; align-items: center; gap: 12px; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-weight: 700; font-size: 12px; text-transform: uppercase; min-width: 50px; text-align: center; }
        .badge-mp3 { background: var(--mp3-bg); }
        .badge-mp4 { background: var(--mp4-bg); }
        .quality-text { font-weight: 600; font-size: 14px; color: #333; }
        .size-text { font-size: 13px; color: #999; font-weight: 400; }
        .dl-btn { text-decoration: none; border: 2px solid var(--primary); color: var(--primary); background: transparent; padding: 6px 18px; border-radius: 6px; font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: 0.2s; }
        .dl-btn:hover { background: var(--primary); color: white; }
        .error-msg { background: #fff3cd; color: #856404; padding: 15px; text-align: center; border-radius: 8px; margin-top: 20px; }
    </style>
</head>
<body>

    <nav>
        <a href="#" class="logo"><i class="fas fa-bolt" style="color:var(--primary);"></i> Vids<span>Save</span></a>
    </nav>

    <section class="hero">
        <h1>Video Downloader</h1>
        <div class="search-box">
            <input type="text" id="urlInput" placeholder="Paste link (YouTube, Insta, FB)..." oninput="handlePaste()">
            <button class="btn-go" onclick="fetchVideo()"><i class="fas fa-arrow-right"></i></button>
        </div>
        <div id="loader"><i class="fas fa-spinner fa-spin"></i> Finding Links...</div>
    </section>

    <div id="result-area"></div>

    <script>
        let debounceTimer;
        function handlePaste() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const url = document.getElementById('urlInput').value;
                if(url.length > 10 && url.includes("http")) fetchVideo();
            }, 1000);
        }

        async function fetchVideo() {
            const urlInput = document.getElementById('urlInput');
            const resultArea = document.getElementById('result-area');
            const loader = document.getElementById('loader');
            const url = urlInput.value.trim();

            if (!url) return;

            loader.style.display = 'block';
            resultArea.innerHTML = '';

            const apiKey = 'fa714c86ccmsh14d7483011d8231p1fae75jsnaaba55ce7db8'; 
            const endpoint = 'https://social-download-all-in-one.p.rapidapi.com/v1/social/autolink';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'content-type': 'application/json', 'X-RapidAPI-Key': apiKey, 'X-RapidAPI-Host': 'social-download-all-in-one.p.rapidapi.com' },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();
                loader.style.display = 'none';

                if (!data || (!data.medias && !data.url)) throw new Error("No video found");

                const title = data.title || "VidsSave Download";
                const thumbnail = data.thumbnail || "https://via.placeholder.com/400x250?text=Video+Preview";
                const duration = data.duration ? `Duration: ${data.duration}` : '';

                // SORTING LOGIC
                const getQualityWeight = (q) => {
                    if(!q) return 0;
                    q = q.toLowerCase();
                    if(q.includes('4k')) return 100;
                    if(q.includes('1080')) return 80;
                    if(q.includes('720')) return 70;
                    if(q.includes('480')) return 60;
                    if(q.includes('360')) return 50;
                    return 10;
                };

                let audioItems = [];
                let videoItems = [];

                if (data.medias && data.medias.length > 0) {
                    data.medias.forEach(media => {
                        let ext = media.extension || 'mp4';
                        let qual = media.quality || 'HD';
                        if(qual === 'render_1080p') qual = '1080P';
                        if(!isNaN(qual)) qual = qual + 'P';
                        
                        let item = { ...media, cleanQuality: qual.toUpperCase(), ext: ext };

                        if (ext === 'mp3' || ext === 'm4a') {
                            audioItems.push(item);
                        } else {
                            if(qual !== 'no_video') videoItems.push(item);
                        }
                    });
                    videoItems.sort((a, b) => getQualityWeight(b.quality) - getQualityWeight(a.quality));
                } else if (data.url) {
                    videoItems.push({ url: data.url, ext: 'mp4', cleanQuality: 'Standard', formattedSize: '' });
                }

                // --- SMART DOWNLOAD BUTTON ---
                const createRow = (item, isAudio) => {
                    const badgeClass = isAudio ? 'badge-mp3' : 'badge-mp4';
                    const label = isAudio ? 'MP3' : 'MP4';
                    const size = item.formattedSize || '';
                    
                    // AGAR GOOGLE VIDEO HAI TO DIRECT LINK OPEN KAREIN (Avoid 403)
                    // AGAR INSTA/TIKTOK HAI TO FORCE DOWNLOAD KAREIN
                    let action = `smartDownload('${item.url}', this)`;
                    
                    return `
                    <div class="dl-item">
                        <div class="dl-info">
                            <span class="badge ${badgeClass}">${label}</span>
                            <div>
                                <div class="quality-text">${item.cleanQuality}</div>
                                <div class="size-text">${size}</div>
                            </div>
                        </div>
                        <button class="dl-btn" onclick="${action}">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>`;
                };

                let audioHTML = audioItems.map(item => createRow(item, true)).join('');
                let videoHTML = videoItems.map(item => createRow(item, false)).join('');

                resultArea.innerHTML = `
                    <div class="result-card">
                        <div class="card-header">
                            <img src="${thumbnail}" class="thumb-img">
                            <div class="video-title">${title}</div>
                            <div class="video-meta">${duration}</div>
                        </div>
                        ${audioHTML ? `<div class="category-header"><i class="fas fa-music"></i> Music</div><div>${audioHTML}</div>` : ''}
                        ${videoHTML ? `<div class="category-header"><i class="fas fa-video"></i> Video</div><div>${videoHTML}</div>` : ''}
                    </div>
                `;

            } catch (error) {
                loader.style.display = 'none';
                resultArea.innerHTML = `<div class="error-msg">Video not found or Private link.</div>`;
            }
        }

        // --- NEW SMART DOWNLOAD LOGIC ---
        function smartDownload(url, btn) {
            // Check if it's a Google/YouTube link
            if (url.includes("googlevideo.com") || url.includes("youtube")) {
                // Google links ko New Tab me open karo (Direct Download often fails due to IP lock)
                // Hum 'noreferrer' use kar rahe hain taaki Google ko pata na chale request kahan se aayi
                window.open(url, '_blank', 'noreferrer');
                
                // User ko batao
                btn.innerHTML = "<i class='fas fa-check'></i> Opening...";
                setTimeout(() => btn.innerHTML = "<i class='fas fa-download'></i> Download", 2000);
            } else {
                // TikTok/Insta ke liye Direct Download (Blob method)
                forceDownload(url, btn);
            }
        }

        async function forceDownload(url, btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Saving...";
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Network response was not ok");
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = "VidsSave_Video.mp4";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(blobUrl);
                a.remove();
                btn.innerHTML = "<i class='fas fa-check'></i> Saved!";
            } catch (error) {
                // Fallback: Agar fail ho jaye to new tab me kholo
                window.open(url, '_blank');
                btn.innerHTML = "<i class='fas fa-external-link-alt'></i> Opened";
            }
            
            setTimeout(() => btn.innerHTML = originalText, 3000);
        }
    </script>
</body>
</html>
